{{ block styles }}
<style>
    .otree-btn-next {
        display: none;
    }
</style>
{{ endblock }}

{{ block title }}
Captcha page
{{ endblock }}

{{ block content }}
<div class="d-flex flex-column align-items-center">
    <h3>Iteration <span id="iter-txt">1</span></h3>
    <p>Solved: <span id="solved-txt">0</span>. Failed: <span id="failed-txt">0</span>.</p>
    <img class="captcha m-1" id="captcha-img">

    <input type="text" id="answer-inp" class="form-control m-1"
           placeholder="enter text from the captcha and press Enter">
</div>

{{ next_button }}

{{ endblock }}

{{ block scripts }}
<script>
    let image = document.getElementById('captcha-img');
    let input = document.getElementById('answer-inp');
    let fields = {
        iter: document.getElementById('iter-txt'),
        solved: document.getElementById('solved-txt'),
        failed: document.getElementById('failed-txt'),
    }

    input.oninput = function (ev) {
        input.classList.remove("is-valid", "is-invalid");
    }

    input.onkeydown = function (ev) {
        if (ev.key === 'Enter') {
            let val = input.value;
            if (val != "") {
                submit(val);
            } else if (js_vars.allow_skip) {
                skip();
            }
        }
    }

    document.addEventListener("DOMContentLoaded", (event) => {
        liveSend({next: true});
    });

    function liveRecv(data) {
        if ('image' in data ) {
            new_puzzle(data.image);
        } else if ('feedback' in data) {
            feedback(data.feedback);
        }
        if ('stats' in data) {
            stats(data.stats);
        }
    }

    function new_puzzle(img) {
        image.src = img;
        input.value = "";
        input.classList.remove("is-valid", "is-invalid");
    }

    function skip() {
        image.src = "";
        next();
    }

    function submit(answer) {
        liveSend({answer: answer});
    }

    function feedback(result) {
        if (result === true) {
            input.classList.add("is-valid");
            next();
        }
        if (result === false) {
            input.classList.add("is-invalid");
            if (!js_vars.force_solve) {
                next();
            }
        }
    }

    function stats(stats) {
        fields.iter.textContent = stats.total;
        fields.solved.textContent = stats.correct;
        fields.failed.textContent = stats.incorrect;
    }

    function next() {
        window.setTimeout(function() {
            liveSend({next: true});
        }, js_vars.trial_delay * 1000);
    }
</script>
{{ endblock }}