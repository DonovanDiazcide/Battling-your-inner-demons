{% block title %}
    Etapa 3: Etapa de adivinanza incentivada de tu resultado del IAT
{% endblock %}

{% block styles %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet"/>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 0;
    }

    /* 1. Form más ancho y adaptativo */
/* 1. Form más ancho y adaptativo */
form {
/* Ancho máximo de formulario */
max-width: 5000px;
/* Ocupa todo el ancho disponible para mantener centrado */
width: 100%;
margin: 1px auto;
padding: 0px;
background-color: #fff;
border-radius: 5px;
box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
box-sizing: border-box;
    h2, h3 {
        color: #333;
        text-align: center;
        margin-bottom: 15px;
    }
    p, ul {
        text-align: center;
        line-height: 1.5;
        color: #444;
    }
    ul {
        list-style-type: none;
        padding: 0;
    }
    ul li {
        margin: 4px 0;
    }

    /* 2. Contenedor flexible para las dos tablas */
    .classification-wrapper {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        margin-bottom: 60px;
    }
    .classification-section {
        width: 45%;
        min-width: 300px;
        box-sizing: border-box;
        margin-bottom: 20px;
    }

    /* 3. Wrapper con scroll horizontal y tabla 100% */
    .table-wrapper {
        overflow-x: auto;
    }
    .table-wrapper table {
        border-collapse: collapse;
        width: 100%;
        min-width: 320px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    .table-wrapper th,
    .table-wrapper td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: center;
    }

    /* Estilo “pizarra” para 7 columnas con botones atractivos */
    .iat-container {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background-color: #333;
        border: 2px solid #fff;
        margin: 20px auto;
        border-radius: 4px;
        overflow: hidden;
    }
    .iat-container label { margin: 0; }
    .iat-column {
        position: relative;
        border-right: 2px solid #fff;
        cursor: pointer;
        text-align: center;
        color: #fff;
        padding: 20px 5px;
        user-select: none;
        transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .iat-column:last-child { border-right: none; }
    .iat-column input[type="radio"] { display: none; }
    .iat-column .text {
        font-size: 0.85rem;
        line-height: 1.3;
    }
    .iat-column:hover {
        background-color: #444;
        transform: translateY(-2px);
    }
    .iat-column input[type="radio"]:checked + .text {
        background-color: #666;
        border-radius: 4px;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* Slider Section */
    .slider-section {
        margin: 25px 0;
    }
    .slider-section label {
        font-weight: bold;
        margin-bottom: 8px;
        display: block;
        text-align: center;
    }
    .range-display {
        margin-top: 8px;
        color: #555;
        font-style: italic;
        text-align: center;
    }
    .slider {
        margin: 0 auto 10px auto;
        width: 90%;
    }

    /* Asociación dinámica */
    .assoc-display {
        text-align: center;
        font-size: 1.1rem;
        color: #007bff;
        margin-bottom: 15px;
    }

    /* Botón */
    button {
        display: block;
        width: 100%;
        padding: 14px;
        margin-top: 30px;
        background-color: #007bff;
        color: #fff;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    button:hover {
        background-color: #0056b3;
    }

    /* Errores */
    .otree-form-errors {
        color: red;
        margin-top: 5px;
        font-size: 0.9rem;
        text-align: center;
    }
</style>

{% endblock %}


{% block content %}
<p>Por el diseño de la prueba, el resultado del IAT se encuentra entre el rango <strong>-2</strong> y <strong>2</strong>:</p>
    <p>Tu resultado podrá corresponder a alguno de los siguientes 4 rangos puntuaciones y asociaciones:</p>
<!-- IAT: Personas obesas/Personas delgadas -->
<div>
  <h2>IAT: Personas obesas/Personas delgadas</h2>
  <div class="classification-wrapper">
    <!-- Clasificaciones Negativas -->
    <div class="classification-section">
      <h3>Puntuaciones menores a 0</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Rango</th>
              <th>Asociación</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>[-0.15, 0.15]</td>
              <td><strong>Neutral</strong></td>
            </tr>
            <tr>
              <td>[-0.35, -0.16]</td>
              <td><strong>Leve</strong>: <strong>personas delgadas</strong> positivo, <strong>personas obesas</strong> negativo</td>
            </tr>
            <tr>
              <td>[-0.65, -0.36]</td>
              <td><strong>Moderada</strong>: <strong>personas delgadas</strong> positivo, <strong>personas obesas</strong> negativo</td>
            </tr>
            <tr>
              <td>[-2, -0.66]</td>
              <td><strong>Fuerte</strong>: <strong>personas delgadas</strong> positivo, <strong>personas obesas</strong> negativo</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Clasificaciones Positivas -->
    <div class="classification-section">
      <h3>Puntuaciones mayores a 0</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Rango</th>
              <th>Asociación</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>[-0.15, 0.15]</td>
              <td><strong>Neutral</strong></td>
            </tr>
            <tr>
              <td>[0.16, 0.35]</td>
              <td><strong>Leve</strong>: <strong>personas obesas</strong> positivo, <strong>personas delgadas</strong> negativo</td>
            </tr>
            <tr>
              <td>[0.36, 0.65]</td>
              <td><strong>Moderada</strong>: <strong>personas obesas</strong> positivo, <strong>personas delgadas</strong> negativo</td>
            </tr>
            <tr>
              <td>[0.66, 2]</td>
              <td><strong>Fuerte</strong>: <strong>personas obesas</strong> positivo, <strong>personas delgadas</strong> negativo</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- IAT: Personas homosexuales/Personas heterosexuales -->
<div>
  <h2>IAT: Personas homosexuales/Personas heterosexuales</h2>
  <div class="classification-wrapper">
    <!-- Clasificaciones Negativas -->
    <div class="classification-section">
      <h3>Puntuaciones menores a 0</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Rango</th>
              <th>Asociación</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>[-0.15, 0.15]</td>
              <td><strong>Neutral</strong></td>
            </tr>
            <tr>
              <td>[-0.35, -0.16]</td>
              <td><strong>Leve</strong>: <strong>personas heterosexuales</strong> positivo, <strong>personas homosexuales</strong> negativo</td>
            </tr>
            <tr>
              <td>[-0.65, -0.36]</td>
              <td><strong>Moderada</strong>: <strong>personas heterosexuales</strong> positivo, <strong>personas homosexuales</strong> negativo</td>
            </tr>
            <tr>
              <td>[-2, -0.66]</td>
              <td><strong>Fuerte</strong>: <strong>personas heterosexuales</strong> positivo, <strong>personas homosexuales</strong> negativo</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Clasificaciones Positivas -->
    <div class="classification-section">
      <h3>Puntuaciones mayores a 0</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Rango</th>
              <th>Asociación</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>[-0.15, 0.15]</td>
              <td><strong>Neutral</strong></td>
            </tr>
            <tr>
              <td>[0.16, 0.35]</td>
              <td><strong>Leve</strong>: <strong>personas homosexuales</strong> positivo, <strong>personas heterosexuales</strong> negativo</td>
            </tr>
            <tr>
              <td>[0.36, 0.65]</td>
              <td><strong>Moderada</strong>: <strong>personas homosexuales</strong> positivo, <strong>personas heterosexuales</strong> negativo</td>
            </tr>
            <tr>
              <td>[0.66, 2]</td>
              <td><strong>Fuerte</strong>: <strong>personas homosexuales</strong> positivo, <strong>personas heterosexuales</strong> negativo</td>
            </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<!-- Mensaje introductorio para la selección -->
<h3>¿Cuál crees que es el rango de puntuación y asociación de tu IAT Personas obesas - Personas delgadas?</h3>
<p> A través de la siguiente barra clickeable, selecciona el rango de puntuación y asociación donde crees que se encuentra tu IAT, solo en caso de que aciertes, te daremos una compensación monetaria por ello.
</p>
<form method="post">

  <!-- ====================== IAT1: Personas obesas/Personas delgadas ====================== -->
  <div class="iat-container">
    <label class="iat-column">
      <input type="radio" name="iat1_self_assessment" value="Fuerte: personas delgadas+bueno, personas obesas+malo" />
      <div class="text">
        <strong>Fuerte</strong><br>
        personas delgadas+bueno, personas obesas+malo<br>
        <span style="font-size:0.8rem">(Rango: [-2, -0.66])</span>
      </div>
    </label>
    <label class="iat-column">
      <input type="radio" name="iat1_self_assessment" value="Moderada: personas delgadas+bueno, personas obesas+malo" />
      <div class="text">
        <strong>Moderada</strong><br>
        personas delgadas+bueno, personas obesas+malo<br>
        <span style="font-size:0.8rem">(Rango: [-0.65, -0.36])</span>
      </div>
    </label>
    <label class="iat-column">
      <input type="radio" name="iat1_self_assessment" value="Leve: personas delgadas+bueno, personas obesas+malo" />
      <div class="text">
        <strong>Leve</strong><br>
        personas delgadas+bueno, personas obesas+malo<br>
        <span style="font-size:0.8rem">(Rango: [-0.35, -0.16])</span>
      </div>
    </label>
    <label class="iat-column">
      <input type="radio" name="iat1_self_assessment" value="Neutral" />
      <div class="text">
        <strong>Neutral</strong><br>
        <span style="font-size:0.8rem">(Rango: [-0.15, 0.15])</span>
      </div>
    </label>
    <label class="iat-column">
      <input type="radio" name="iat1_self_assessment" value="Leve: personas obesas+bueno, personas delgadas+malo" />
      <div class="text">
        <strong>Leve</strong><br>
        personas obesas+bueno, personas delgadas+malo<br>
        <span style="font-size:0.8rem">(Rango: [0.16, 0.35])</span>
      </div>
    </label>
    <label class="iat-column">
      <input type="radio" name="iat1_self_assessment" value="Moderada: personas obesas+bueno, personas delgadas+malo" />
      <div class="text">
        <strong>Moderada</strong><br>
        personas obesas+bueno, personas delgadas+malo<br>
        <span style="font-size:0.8rem">(Rango: [0.36, 0.65])</span>
      </div>
    </label>
    <label class="iat-column">
      <input type="radio" name="iat1_self_assessment" value="Fuerte: personas obesas+bueno, personas delgadas+malo" />
      <div class="text">
        <strong>Fuerte</strong><br>
        personas obesas+bueno, personas delgadas+malo<br>
        <span style="font-size:0.8rem">(Rango: [0.66, 2])</span>
      </div>
    </label>
  </div>
  {{ formfield_errors 'iat1_self_assessment' }}

    <!-- Range Slider (Double-handle) para iat1_lower_limit e iat1_upper_limit -->
    <div class="slider-section">
      <label>
          <h3>¿Cuál sería para ti un rango moralmente aceptable para el IAT Persona obesa/Persona delgada?</h3>
      </label>
          <p>Dado que ya conoces los rangos de puntuaciones y asociaciones de la prueba, ¿cuál consideras que
          es el rango de puntuación y asociación moralmente aceptable para este IAT? <br> Puedes seleccionar el límite superior e
          inferior de tu rango de puntuación y asociación mediante esta barra, cuyos límites puedes mover con el mouse, touchpad o
          pantalla. Tienes dos textos: en el primero te indicamos el rango de puntuación que actualmente estás seleccionando
          y en el segundo te mostramos la o las asociaciones que actualmente estés seleccionando</p>
          <br>
        <label> Actualmente estás seleccionando:
        <span class="range-display" id="display_iat1_range"></span>
      </label>
      <div id="slider_iat1" class="slider"></div>
      <div class="assoc-display" id="assoc_iat1"></div>
      <!-- Inputs ocultos -->
      <input type="hidden" name="iat1_lower_limit" id="iat1_lower_limit"/>
      <input type="hidden" name="iat1_upper_limit" id="iat1_upper_limit"/>
      {{ formfield_errors 'iat1_lower_limit' }}
      {{ formfield_errors 'iat1_upper_limit' }}
    </div>

    <hr>

  <!-- ====================== IAT2: Personas homosexuales/Personas heterosexuales ====================== -->
<h3>¿Cuál crees que es el rango de puntuación y asociación de tu IAT personas homosexuales y personas heterosexuales?</h3>
<p> A través de la siguiente barra clickeable, selecciona el rango de puntuación y asociación donde crees que se encuentra tu IAT, solo en caso de que aciertes, te daremos una compensación monetaria por ello.</p>

<!-- Radio Buttons (7 columnas) con Neutral centrado -->
<div class="iat-container">
  <!-- Opción 1: Fuerte personas heterosexuales+bueno, personas homosexuales+malo -->
  <label class="iat-column">
    <input type="radio" name="iat2_self_assessment" value="Fuerte: personas heterosexuales+bueno, personas homosexuales+malo" />
    <div class="text">
      <strong>Fuerte</strong><br>
      personas heterosexuales+bueno, personas homosexuales+malo<br>
      <span style="font-size:0.8rem">(Rango: [-2, -0.66])</span>
    </div>
  </label>
  <!-- Opción 2: Moderada personas heterosexuales+bueno, personas homosexuales+malo -->
  <label class="iat-column">
    <input type="radio" name="iat2_self_assessment" value="Moderada: personas heterosexuales+bueno, personas homosexuales+malo" />
    <div class="text">
      <strong>Moderada</strong><br>
      personas heterosexuales+bueno, personas homosexuales+malo<br>
      <span style="font-size:0.8rem">(Rango: [-0.65, -0.36])</span>
    </div>
  </label>
  <!-- Opción 3: Leve personas heterosexuales+bueno, personas homosexuales+malo -->
  <label class="iat-column">
    <input type="radio" name="iat2_self_assessment" value="Leve: personas heterosexuales+bueno, personas homosexuales+malo" />
    <div class="text">
      <strong>Leve</strong><br>
      personas heterosexuales+bueno, personas homosexuales+malo<br>
      <span style="font-size:0.8rem">(Rango: [-0.35, -0.16])</span>
    </div>
  </label>
  <!-- Opción 4: Neutral -->
  <label class="iat-column">
    <input type="radio" name="iat2_self_assessment" value="Neutral" />
    <div class="text">
      <strong>Neutral</strong><br>
      <span style="font-size:0.8rem">(Rango: [-0.15, 0.15])</span>
    </div>
  </label>
  <!-- Opción 5: Leve personas homosexuales+bueno, personas heterosexuales+malo -->
  <label class="iat-column">
    <input type="radio" name="iat2_self_assessment" value="Leve: personas homosexuales+bueno, personas heterosexuales+malo" />
    <div class="text">
      <strong>Leve</strong><br>
      personas homosexuales+bueno, personas heterosexuales+malo<br>
      <span style="font-size:0.8rem">(Rango: [0.16, 0.35])</span>
    </div>
  </label>
  <!-- Opción 6: Moderada personas homosexuales+bueno, personas heterosexuales+malo -->
  <label class="iat-column">
    <input type="radio" name="iat2_self_assessment" value="Moderada: personas homosexuales+bueno, personas heterosexuales+malo" />
    <div class="text">
      <strong>Moderada</strong><br>
      personas homosexuales+bueno, personas heterosexuales+malo<br>
      <span style="font-size:0.8rem">(Rango: [0.36, 0.65])</span>
    </div>
  </label>
  <!-- Opción 7: Fuerte personas homosexuales+bueno, personas heterosexuales+malo -->
  <label class="iat-column">
    <input type="radio" name="iat2_self_assessment" value="Fuerte: personas homosexuales+bueno, personas heterosexuales+malo" />
    <div class="text">
      <strong>Fuerte</strong><br>
      personas homosexuales+bueno, personas heterosexuales+malo<br>
      <span style="font-size:0.8rem">(Rango: [0.66, 2])</span>
    </div>
  </label>
</div>
{{ formfield_errors 'iat2_self_assessment' }}

    <!-- Range Slider (Double-handle) para iat2_lower_limit e iat2_upper_limit -->
    <div class="slider-section">
        <h3>¿Cuál sería para ti un rango moralmente aceptable para el IAT persona homosexual/persona heterosexual?</h3>
          <p>Dado que ya conoces los rangos de puntuaciones y asociaciones de la prueba, ¿cuál consideras que
          es el rango de puntuación y asociación moralmente aceptable para este IAT? <br> Puedes seleccionar el límite superior e
          inferior de tu rango de puntuación y asociación mediante esta barra, cuyos límites puedes mover con el mouse, touchpad o
          pantalla. Tienes dos textos: en el primero te indicamos el rango de puntuación que actualmente estás seleccionando
          y en el segundo te mostramos la o las asociaciones que actualmente estés seleccionando</p>
      <label>
          <br> Actualmente estás seleccionando:
        <span class="range-display" id="display_iat2_range"></span>
      </label>
      <div id="slider_iat2" class="slider"></div>
      <div class="assoc-display" id="assoc_iat2"></div>
      <input type="hidden" name="iat2_lower_limit" id="iat2_lower_limit"/>
      <input type="hidden" name="iat2_upper_limit" id="iat2_upper_limit"/>
      {{ formfield_errors 'iat2_lower_limit' }}
      {{ formfield_errors 'iat2_upper_limit' }}
    </div>

    <button type="submit">Continuar</button>
</form>

<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
<script>
  // Función para determinar la clasificación en función del valor (incluye umbrales inclusivos)
  function getClassification(value) {
      var absVal = Math.abs(value);
      if (absVal <= 0.15) {
          return "Neutral";
      } else if (absVal <= 0.35) {
          return "Asociación leve";
      } else if (absVal <= 0.65) {
          return "Asociación moderada";
      } else {
          return "Asociación fuerte";
      }
  }

  // LÓGICA PARA IAT1 (personas obesas/personas delgadas)
  function getAssociationIAT1(lower, upper) {
      if (lower >= -0.15 && upper <= 0.15) {
          return "Neutral";
      } else if (upper <= -0.15) {
          var c1 = getClassification(lower);
          var c2 = getClassification(upper);
          var classes = [];
          if (c1 !== "Neutral") classes.push(c1);
          if (c2 !== c1 && c2 !== "Neutral") classes.push(c2);
          return classes
            .map(function(cl){ return cl + " a personas delgadas+bueno, personas obesas+malo"; })
            .join(" y ");
      } else if (lower >= 0.15) {
          var c1 = getClassification(lower);
          var c2 = getClassification(upper);
          var classes = [];
          if (c1 !== "Neutral") classes.push(c1);
          if (c2 !== c1 && c2 !== "Neutral") classes.push(c2);
          return classes
            .map(function(cl){ return cl + " a personas obesas+bueno, personas delgadas+malo"; })
            .join(" y ");
      } else {
          var parts = [];
          if (lower < -0.15) {
              var cn = getClassification(lower);
              if (cn !== "Neutral") parts.push(cn + " a personas delgadas+bueno, personas obesas+malo");
          }
          if (lower <  0.15 && upper > -0.15) {
              parts.push("Neutral");
          }
          if (upper > 0.15) {
              var cp = getClassification(upper);
              if (cp !== "Neutral") parts.push(cp + " a personas obesas+bueno, personas delgadas+malo");
          }
          return parts.join(" y ");
      }
  }

  // LÓGICA PARA IAT2 (personas homosexuales/personas heterosexuales)
  function getAssociationIAT2(lower, upper) {
      if (lower >= -0.15 && upper <= 0.15) {
          return "Neutral";
      } else if (upper <= -0.15) {
          var c1 = getClassification(lower);
          var c2 = getClassification(upper);
          var classes = [];
          if (c1 !== "Neutral") classes.push(c1);
          if (c2 !== c1 && c2 !== "Neutral") classes.push(c2);
          return classes
            .map(function(cl){ return cl + " a personas heterosexuales+bueno, personas homosexuales+malo"; })
            .join(" y ");
      } else if (lower >= 0.15) {
          var c1 = getClassification(lower);
          var c2 = getClassification(upper);
          var classes = [];
          if (c1 !== "Neutral") classes.push(c1);
          if (c2 !== c1 && c2 !== "Neutral") classes.push(c2);
          return classes
            .map(function(cl){ return cl + " a personas homosexuales+bueno, personas heterosexuales+malo"; })
            .join(" y ");
      } else {
          var parts = [];
          if (lower < -0.15) {
              var cn = getClassification(lower);
              if (cn !== "Neutral") parts.push(cn + " a personas heterosexuales+bueno, personas homosexuales+malo");
          }
          if (lower <  0.15 && upper > -0.15) {
              parts.push("Neutral");
          }
          if (upper > 0.15) {
              var cp = getClassification(upper);
              if (cp !== "Neutral") parts.push(cp + " a personas homosexuales+bueno, personas heterosexuales+malo");
          }
          return parts.join(" y ");
      }
  }

  // IAT1: slider de doble handle
  var sliderIAT1 = document.getElementById('slider_iat1');
  noUiSlider.create(sliderIAT1, {
      start: [-0.15, 0.15],
      connect: true,
      range: { 'min': -2, 'max': 2 },
      step: 0.01
  });
  var iat1Lower   = document.getElementById('iat1_lower_limit');
  var iat1Upper   = document.getElementById('iat1_upper_limit');
  var displayIAT1 = document.getElementById('display_iat1_range');
  var assocIAT1   = document.getElementById('assoc_iat1');

  sliderIAT1.noUiSlider.on('update', function (values) {
      var lowerVal = parseFloat(values[0]);
      var upperVal = parseFloat(values[1]);
      iat1Lower.value = lowerVal;
      iat1Upper.value = upperVal;
      displayIAT1.textContent = '[' + lowerVal.toFixed(2) + ', ' + upperVal.toFixed(2) + ']';
      assocIAT1.innerHTML = "Actualmente, tu rango moral se clasifica como:<br>" + getAssociationIAT1(lowerVal, upperVal);
  });

  // IAT2: slider de doble handle
  var sliderIAT2 = document.getElementById('slider_iat2');
  noUiSlider.create(sliderIAT2, {
      start: [-0.15, 0.15],
      connect: true,
      range: { 'min': -2, 'max': 2 },
      step: 0.01
  });
  var iat2Lower   = document.getElementById('iat2_lower_limit');
  var iat2Upper   = document.getElementById('iat2_upper_limit');
  var displayIAT2 = document.getElementById('display_iat2_range');
  var assocIAT2   = document.getElementById('assoc_iat2');

  sliderIAT2.noUiSlider.on('update', function (values) {
      var lowerVal = parseFloat(values[0]);
      var upperVal = parseFloat(values[1]);
      iat2Lower.value = lowerVal;
      iat2Upper.value = upperVal;
      displayIAT2.textContent = '[' + lowerVal.toFixed(2) + ', ' + upperVal.toFixed(2) + ']';
      assocIAT2.innerHTML = "Actualmente, tu rango moral se clasifica como:<br>" + getAssociationIAT2(lowerVal, upperVal);
  });
</script>

{% endblock %}
