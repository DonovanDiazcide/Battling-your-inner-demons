import time
import random
import logging

# from .admin_report_functions import *
from otree.api import *
from otree import settings
from . import stimuli
from . import stats
from . import blocks
import math
from statistics import mean, stdev
from decimal import Decimal

# comentarios.
doc = """
Implicit Association Test, draft
"""
from statistics import mean, stdev



def dscore1(data3: list, data4: list, data6: list, data7: list):
    # Filtrar valores demasiado largos.
    def not_long(value):
        return value < 10.0

    data3 = list(filter(not_long, data3))
    data4 = list(filter(not_long, data4))
    data6 = list(filter(not_long, data6))
    data7 = list(filter(not_long, data7))

    # Filtrar valores demasiado cortos
    def too_short(value):
        return value < 0.300

    total_data = data3 + data4 + data6 + data7
    short_data = list(filter(too_short, total_data))

    if len(total_data) == 0 or (len(short_data) / len(total_data) > 0.1):
        return None

    # Calcular el d-score
    combined_3_6 = data3 + data6
    combined_4_7 = data4 + data7

    if len(combined_3_6) < 2 or len(combined_4_7) < 2:
        # stdev requiere al menos dos datos
        return None

    std_3_6 = stdev(combined_3_6)
    std_4_7 = stdev(combined_4_7)

    mean_3_6 = mean(data6) - mean(data3) if len(data6) > 0 and len(data3) > 0 else 0
    mean_4_7 = mean(data7) - mean(data4) if len(data7) > 0 and len(data4) > 0 else 0

    dscore_3_6 = mean_3_6 / std_3_6 if std_3_6 > 0 else 0
    dscore_4_7 = mean_4_7 / std_4_7 if std_4_7 > 0 else 0

    dscore_mean1 = (dscore_3_6 + dscore_4_7) * 0.5
    return dscore_mean1


def dscore2(data10: list, data13: list, data11: list, data14: list):
    # Filtrar valores demasiado largos
    def not_long(value):
        return value < 10.0

    data10 = list(filter(not_long, data10))
    data13 = list(filter(not_long, data13))
    data11 = list(filter(not_long, data11))
    data14 = list(filter(not_long, data14))

    # Filtrar valores demasiado cortos
    def too_short(value):
        return value < 0.300

    total_data = data10 + data13 + data11 + data14
    short_data = list(filter(too_short, total_data))

    if len(total_data) == 0 or (len(short_data) / len(total_data) > 0.1):
        return None

    # Calcular el d-score
    combined_10_11 = data10 + data11
    combined_13_14 = data13 + data14

    if len(combined_10_11) < 2 or len(combined_13_14) < 2:
        # stdev requiere al menos dos datos
        return None

    std_10_11 = stdev(combined_10_11)
    std_13_14 = stdev(combined_13_14)

    mean_10_11 = mean(data11) - mean(data10) if len(data11) > 0 and len(data10) > 0 else 0
    mean_13_14 = mean(data14) - mean(data13) if len(data14) > 0 and len(data13) > 0 else 0

    dscore_10_11 = mean_10_11 / std_10_11 if std_10_11 > 0 else 0
    dscore_13_14 = mean_13_14 / std_13_14 if std_13_14 > 0 else 0

    dscore_mean2 = (dscore_10_11 + dscore_13_14) * 0.5
    return dscore_mean2



class Constants(BaseConstants):
    name_in_url = 'iat'
    players_per_group = None
    num_rounds = 16  # 14 para iat + 4 para dictador

    keys = {"e": 'left', "i": 'right'}
    trial_delay = 0.250
    endowment = Decimal('100')  # Añadido para dictador
    categories = ['personas delgadas y personas obesas', 'personas homosexuales y personas heterosexuales']  # Categorías para el Dictador
    PersonasDelgadas = "personas delgadas"
    PersonasObesas = "personas obesas"
    PersonasHeterosexuales = "personas heterosexuales"
    PersonasHomosexuales = "personas homosexuales"

    # 1 ·  lista canónica para no repetir
    STAGES_CORRECT = [
        "Sociodemográfica",
        "Pruebas de asociación implícita",
        "Adivinas tus puntajes en las pruebas de la Etapa 2",
        "Rango aceptable de puntajes en las pruebas de la Etapa 2",
        "Qué información revelar en las decisiones de la Etapa 6",
        "Decisiones monetarias que pueden afectar a grupos de la Etapa 2",
    ]

    CORRECT_ANSWERS = dict(
        comp_q1='e',
        comp_q2='b',
        stage_order="\n".join(STAGES_CORRECT),  # tu BooleanField usa True/False
        comp_q4='c',
        comp_q5='d',
        comp_q6='c',
    )

    QUESTION_TEXT = dict(
        comp_q1=(
            '1. Supón que haces una prueba de asociación implícita que involucra a grupos A y B, en donde el grupo B es el grupo “base”. ¿Qué puntaje indicaría que tu sesgo implícito es igual al promedio de cientos de miles de participantes? ¿Qué puntaje indicaría que tu sesgo implícito favorece al grupo A más que el promedio de cientos de miles de participantes?'),
        comp_q2=(
            '2. ¿Cuáles son las dos características que hace que la Prueba de Asociación Implícita sea una manera robusta de medir sesgos que tal vez ni siquiera sabías que tenías?'),
        stage_order=(
            "3. Arrastra las etapas para ponerlas en el orden correcto:"
        ),
        comp_q4=('4. En la Etapa 5 (qué información revelar en la Etapa 6), ¿cómo tomas la decisión de qué se te revela en la Etapa 6?'),
        comp_q5=('5. Supón que nos indicas que quieres que en la Etapa 6 te revelemos la identidad de los grupos A y B, y que no te revelemos la identidad de los grupos C y D. ¿Qué haríamos en la práctica?'),
        comp_q6=('6. ¿Qué es lo que cada participantes debe adivinar sobre los miembros de su grupo en este experimento?'),
    )

    QUESTION_OPTIONS = dict(
        comp_q1=[
            ('a',
             'a) Un puntaje positivo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje de cero indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes.'),
            ('b',
             'b) Un puntaje positivo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje negativo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes.'),
            ('c',
             'c) Un puntaje de cero indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje positivo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes.'),
            ('d',
             'd) Un puntaje de cero indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje negativo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '),
            ('e',
             'e) Un puntaje negativo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje de cero indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes.'
             ),
            ('f',
             'f) Un puntaje negativo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje positivo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '
             ),
        ],

        comp_q2=[
            ('a',
             'a) Primero, hay una base de datos con cientos de miles de participantes que ya tomaron la prueba. Segundo, fue desarrollado por académicos.'),
            ('b',
             'b) Primero, está ligado a comportamientos relevantes en el mundo real. Segundo, es difícil de manipular ya que mide tu respuesta automática, sin que hayas tenido tiempo de pensar. '),
            ('c', 'c) Primero, no existen otras pruebas para medir sesgos. Segundo, es fácil de implementar.'),
        ],

        stage_order=[],

        comp_q4=[
            ('a',
             '4. Caclula la cantidad de dinero con la que termina el siguiente participante: <br>'
            '  • Paga el costo para decidir dar o quitar 20 pesos a cada miembro del grupo.<br>'
            '  • Expresa la opinión alterna a su opinión privada.<br>'
            '  • Los otros miembros no pagan el costo para decidir dar o quitar 20 pesos.<br>'
            '  • Adivina correctamente el porcentaje de personas que expresaron una opinión diferente a su opinión privada en esas "conversaciónes", y recibe 10 pesos extra.<br>'
            '  • Advina correctamente si la opinión que le expresaron los demás miembros es igual a su opinión privada, y recibe 10 pesos adicionales.<br>'),
            ('b',
             'b) Tomas una decisión para cada grupo a los cuales puedes afectar monetariamente en la Etapa 6: decides directamente si se te informa o no sobre la identidad de cada grupo cuando estés en la Etapa 6.'),
            ('c',
             'c) Nos vas a decir si quieres que te revelemos la identidad de los grupos correspondientes a una decisión dependiendo de si tu puntaje en la prueba de asociación implícita cayó debajo, dentro o arriba del rango que consideras aceptable. '),
        ],

        comp_q5=[
            ('a', 'a) Te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D.'),
            ('b', 'b) Te revelamos la identidad de los grupos A y B con 80% de probabilidad, y con 20% de probabilidad no te revelamos la identidad de los grupos A y B. No te revelamos la dentidad de los grupos C y D.'),
            ('c', 'c) Te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D con 80% de probabilidad, y con 20% de probabilidad sí te revelamos la identidad de los grupos C y D. '),
            ('d',
             'd) Te revelamos la identidad de los grupos A y B con 80% de probabilidad, y con 20% de probabilidad no te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D con 80% de probabilidad, y con 20% de probabilidad sí te revelamos la identidad de los grupos C y D.'),
        ],
        comp_q6=[
            ('a',
             'a) Ninguna decisión involucra a los grupos de personas sobre las que te preguntamos en las pruebas de la Etapa 2, y sólo vamos a incluir decisiones que no afecten a las personas sobre las que te preguntamos en la Etapa 2. '),
            ('b',
             'b) No todas las decisiones involucran a los grupos de personas sobre las que te preguntamos en las pruebas de la Etapa 2, y es posible que incluyamos decisiones que no afecten a algunas de las personas sobre las que te preguntamos en la Etapa 2. '),
            ('c',
             'c) Todas las decisiones involucran a los grupos de personas sobre las que te preguntamos en las pruebas de la Etapa 2, y ninguna decisión van a incluir a grupos de personas sobre las que no te preguntamos en la Etapa 2. '),
        ],
    )

    CORRECT_EXPLANATIONS = dict(
        comp_q1='Tu puntaje se compara con los datos de Project Implicit, una base con cientos de miles de participantes. Una puntuación de cero representa el promedio de dicha base. La interpretación del puntaje depende de cuál de los dos grupos es el grupo "base" para fines de la comparación. En la pregunta, el grupo B es el grupo "base". Un puntaje positivo indicaría que, comparado a la base de datos de Project Implicit, el/la participante asocia con mayor facilidad a los del grupo B con los atributos positivos en comparación la asociación que hace con los del grupo A. Un puntaje negativo indica una asociación relativamente más fuerte de los del grupo A con atributos positivos en comparación con la asociación con los del grupo B. ',
        comp_q2='Como mostramos con los estudios que mencionamos, hay mucha evidencia que la Prueba de Asociación Implícita está ligada a comportamientos relevantes en el mundo real. A diferencia de otras pruebas, la Prueba de Asociación Implícita es difícil de manipular ya que mide tu respuesta automática---tu primera reacción, sin haber tenido tiempo para pensar. Sí existen otras pruebas para medir sesgos que tienen muchos participantes que ya tomaron la prueba, que fueron desarrollados por académicos, pero la Prueba de Asociación Implícita destaca por las dos razones que mencionamos. ',
        stage_order=(
                "El orden correcto es:\n• " + "\n• ".join(STAGES_CORRECT)
        ),
        comp_q4='No es directa la decisión sobre la información que se te revela—no te vamos a preguntar simplemente si quieres que se te revele la información sobre cada grupo. En vez de eso, la decisión va a depender de tus puntajes en las pruebas de asociación implícita y en el rango de puntajes aceptables que nos diste en la cuarta etapa. Para los dos grupos de personas que aparecieron en una de las pruebas, vamos a tomar en cuenta tres rangos en donde pudo haber caído tu puntaje: abajo del rango que consideras aceptable, dentro del rango que consideras aceptable, y arriba del rango que consideras aceptable. Para cada rango, nos vas a decir si quieres que te revelemos la identidad de los grupos correspondientes a la decisión en caso de que tu puntaje de la prueba de asociación que incluía a ese grupo haya caído dentro de ese rango.',
        comp_q5='Recuerda que con 20% de probabilidad vamos a hacer lo contrario a lo que nos pediste que hiciéramos en esta quinta etapa. Si tu puntaje cayó en un rango en el que querías que no te reportáramos la identidad de los grupos, con 20% de probabilidad te la vamos a reportar. Si tu puntaje cayó en un rango en el que sí querías que te reportáramos la identidad de los grupos, con 20% de probabilidad no te la vamos a reportar. Nota que con 80% de probabilidad sí vamos a hacer lo que nos pediste, por lo que sigue siendo mejor para ti reportarnos lo que realmente quieres que hagamos en cada rango. También nota que de esta manera no vas a poder saber con certeza en qué rango cayó tu puntaje de la Prueba de Asociación Implícita basado en la información que recibes en la Etapa 6.',
        comp_q6='Los participantes deben adivinar si la opinión que los demás miembros le expresaron es la misma que expresaron en privado y el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.',
    )

    #cuestionarios de comprensión para el segundo grupo.

    CORRECT_ANSWERS2 = dict(
        comp_q1_2='c',
        comp_q2_2='d',
        comp_q3_2='a',  # tu BooleanField usa True/False
        comp_q4_2='c',
        comp_q5_2='d',
        comp_q6_2='c',
    )

    QUESTION_TEXT2 = dict(
        comp_q1_2=(
            '1. ¿Cuál de las siguientes opciones describe correctamente las acciones disponibles para un participante una vez que se formó su grupo en el experimento?'),
        comp_q2_2=(
            '2. ¿Qué sucede si un participante decide pagar el costo (5 pesos) para darle o quitarle 20 pesos a los demás miembros de su grupo, y el participante decide quitarle 20 pesos a uno de ellos?'),
        comp_q3_2=('3. Calcula la cantidad de dinero con la que termina el siguiente participante: <br>'
                 '  • Paga el costo para decidir dar o quitar 20 pesos a cada miembro del grupo.<br>'
                 '  • Expresa su opinión privada ante el grupo y gana 10 pesos.<br>'
                 '  • Los otros miembros de su grupo deciden quitarle 20 pesos.<br>'
                 '  • Adivina correctamente el porcentaje de personas que expresaron una opinión diferente a su opinión privada en esas "conversaciónes", y recibe 10 pesos extra.<br>'
                 '  • Advinó incorrectamente si la opinión que le expresaron los demás miembros es igual a su opinión privada.<br>'
                 ),
        comp_q4_2=('4. Caclula la cantidad de dinero con la que termina el siguiente participante: <br>'
                 '  • Paga el costo para decidir dar o quitar 20 pesos a cada miembro del grupo.<br>'
                 '  • Expresa la opinión alterna a su opinión privada.<br>'
                 '  • Los otros miembros no pagan el costo para decidir dar o quitar 20 pesos.<br>'
                 '  • Adivina correctamente el porcentaje de personas que expresaron una opinión diferente a su opinión privada en esas "conversaciónes", y recibe 10 pesos extra.<br>'
                 '  • Advina correctamente si la opinión que le expresaron los demás miembros es igual a su opinión privada, y recibe 10 pesos adicionales.<br>'),
        comp_q5_2=('¿Cómo se crean los grupos de tres personas en el experimento?'),
        comp_q6_2=(
            '6. ¿Qué es lo que cada participantes debe adivinar sobre los miembros de su grupo en este experimento?'),
        )

    QUESTION_OPTIONS2 = dict(
        comp_q1_2=[
            ('a',
             'a) Escoger qué opinión expresarle a los demás en el grupo. Decidir si dar o quitar dinero a cada uno de los miembros. Adivinar si la opinión que los demás miembros te expresaron es la misma que expresaron en privado. Adivina el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.'),
            ('b',
             'b) Escoger qué opinión expresarle a los demás en el grupo. Adivinar si la opinión que los demás mimebros te expresaron es la misma que expresaron en privado. Adivina el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.'),
            ('c',
             'c) Escoger qué opinión expresarle a los demás en el grupo. Entre quienes pagaron cinco pesos por hacerlo decidir si dar o quitar dinero a cada uno de los demás miembros del grupo. Adivinar si la opinión que los demás miembros te expresaron es la misma que expresaron en privado. Adivina el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.'),
            ('d',
             'd) Escoger qué opinión expresarle a los demás en el grupo. Entre quienes pagaron cinco pesos por hacerlo decidir si dar o quitar dinero a cada uno de los demás miembros del grupo. Adivina el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.'),
        ],
        comp_q2_2=[
            ('a', 'a) El participante gana 20 pesos'),
            ('b', 'b) El participante recupera los 5 pesos pagados y el otro miembro gana 20 pesos adicionales'),
            ('c', 'c) Sólo el que paga pierde dinero; el otro miembro no gana ni pierde nada'),
            ('d', 'd) El participante pierde 5 pesos y el otro miembro pierde 20 pesos'),
        ],
        comp_q3_2=[
            ('a', 'a) Termina con 25 pesos'),
            ('b', 'b) Termina con -25 pesos. Es decir, acaba sin dinero.'),
            ('c', 'c) Termina con 30 pesos'),
            ('d', 'd) Termina con 45 pesos'),
        ],
        comp_q4_2=[
            ('a', 'a) Termina con 40 pesos'),
            ('b', 'b) Termina con 15 pesos'),
            ('c', 'c) Termina con 65 pesos'),
            ('d', 'd) Termina con 50 pesos'),
        ],
        comp_q5_2=[
            ('a', 'a) Según sus características personales (por ejemplo, edad o género)'),
            ('b', 'b) Los participantes eligen libremente a los mimebros de su grupo'),
            ('c', 'c) De forma totalmente aleatoria'),
            ('d',
             'd) Basándose en las opiniones privadas de los participantes sobre cada uno de los temas de la Parte 3 del experimento'),
        ],
        comp_q6_2=[
            ('a', 'a) Si la opinión que los demás miembros le expresaron es la misma que expresaron en privado'),
            ('b',
             'b) La decisión que tomará cada uno de los mimebros sobre dar o quitar 20 pesos a los demás y si la opinión que los demás miembros le expresaron es la misma que expresaron en privado'),
            ('c',
             'c) Si la opinión que los demás miembros te expresaron es la misma que expresaron en privado y el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.'),
            ('d', 'd) Si la opinión que los demás miembros le expresaron es diferente a su opinión privada'),
        ],
    )

    CORRECT_EXPLANATIONS2 = dict(
        comp_q1_2='Las acciones disponibles para un participante una vez que se formó su grupo son: (1) escoger qué opinión expresarle a los demás en el grupo, (2) para quienes pagaron el costo por hacerlo decidir si dar o quitar dinero a cada uno de los miembros, (3) adivinar si la opinión que los demás miembros te expresaron es la misma que expresaron en privado, y (4) adivinar el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.',
        comp_q2_2='Los participantes que pagan el costo por decidir dar o quitar 20 pesos a los demás miembros de su grupo se les sustrae 5 pesos de su dinero disponible. Si los participantes deciden quitarle 20 pesos a uno de los miembros, esa decisión se aplicará al miembro; pierde 20 pesos.',
        comp_q3_2='El participante recibe 50 pesos por participar, pierde 5, gana 10, pierde 40 y gana 10. Entonces, termina con 50 - 5 + 10 - 40 + 10 = 25 pesos.',
        comp_q4_2='El participante recibe 50 pesos por participar, pierde 5, gana 10 y gana 10. Entonces, termina con 50 - 5 + 10 + 10 = 65 pesos.',
        comp_q5_2='Los grupos de tres personas se forman a partir de las opiniones privadas de los participantes sobre cada uno de los temas de la Parte 3 del experimento.',
        comp_q6_2='Los participantes deben adivinar si la opinión que los demás miembros te expresaron es la misma que expresaron en privado y el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.',
    )



def url_for_image(filename):
    return f"/static/images/{filename}"


class Subsession(BaseSubsession):
    practice = models.BooleanField()
    primary_left = models.StringField()
    primary_right = models.StringField()
    secondary_left = models.StringField()
    secondary_right = models.StringField()


def creating_session(self):
    session = self.session
    defaults = dict(
        retry_delay=0.5,
        trial_delay=0.5,
        primary=[None, None],
        primary_images=False,
        secondary=[None, None],
        secondary_images=False,
        num_iterations={
            # Rondas existentes para iat.
            1: 5, 2: 5, 3: 10, 4: 20, 5: 5, 6: 10, 7: 20,
            8: 5, 9: 5, 10: 10, 11: 20, 12: 5, 13: 10, 14: 20,
            # Rondas adicionales para Dictador.
            15: 1, 16: 1
        },
    )
    session.params = {}
    for param in defaults:
        session.params[param] = session.config.get(param, defaults[param])

    if self.round_number == 1:
        players = list(self.get_players())
        random.shuffle(players)
        mitad = len(players) // 2

        orden_directo = list(range(1, 15))
        orden_invertido = list(range(8, 15)) + list(range(1, 8))

        # 50% → directos
        for p in players[:mitad]:
            p.participant.vars['iat_round_order'] = orden_directo

        # 50% → invertidos
        for p in players[mitad:]:
            p.participant.vars['iat_round_order'] = orden_invertido

        # --- Nuevo bloque: imprime resumen ordenado ---
        print("[IAT ORDER SUMMARY]")
        for p in sorted(players, key=lambda p: p.id_in_subsession):
            order = p.participant.vars['iat_round_order']
            # aquí decides cómo formatear el texto
            print(f"Jugador {p.id_in_subsession}: {order}")

        # tu código de categorías del Dictador sigue igual
        shuffled_categories = Constants.categories.copy()
        random.shuffle(shuffled_categories)
        session.vars['shuffled_dictator_categories'] = shuffled_categories
        # Fijamos orden: 15→delgadas/obesas, 16→homo/hetero
        session.vars['shuffled_dictator_categories'] = Constants.categories.copy()

    block = get_block_for_round(self.round_number, session.params)

    self.practice = block.get('practice', False)
    self.primary_left = block.get('left', {}).get('primary', "")
    self.primary_right = block.get('right', {}).get('primary', "")
    self.secondary_left = block.get('left', {}).get('secondary', "")
    self.secondary_right = block.get('right', {}).get('secondary', "")

        #print("shuffled categories:", shuffled_categories)

    # Asignar categorías al Dictador basadas en la lista aleatoria para las rondas 15-18
    if self.round_number in [15, 16]:
        shuffled_categories = session.vars.get('shuffled_dictator_categories')
        if shuffled_categories:
            # Asignar una categoría por ronda 15-18 al grupo
            assigned_category = shuffled_categories[self.round_number - 15]
            for group in self.get_groups():
                group.dictator_category = assigned_category


def get_block_for_round(rnd, params):
    """Get a round setup from BLOCKS with actual categories' names substituted from session config"""
    if rnd in blocks.BLOCKS:
        block = blocks.BLOCKS[rnd]
        result = blocks.configure(block, params)
        return result
    else:
        # Retorna un bloque vacío o predeterminado para rondas que no lo necesitan
        return {}

def thumbnails_for_block(block, params):
    """Return image urls for each category in block.
    Taking first image in the category as a thumbnail.
    """
    thumbnails = {'left': {}, 'right': {}}
    for side in ['left', 'right']:
        for cls in ['primary', 'secondary']:
            if cls in block[side] and params[f"{cls}_images"]:
                # use first image in categopry as a corner thumbnail
                images = stimuli.DICT[block[side][cls]]
                thumbnails[side][cls] = url_for_image(images[0])
    return thumbnails


def labels_for_block(block):
    """Return category labels for each category in block
    Just stripping prefix "something:"
    """
    labels = {'left': {}, 'right': {}}
    for side in ['left', 'right']:
        for cls in ['primary', 'secondary']:
            if cls in block[side]:
                cat = block[side][cls]
                if ':' in cat:
                    labels[side][cls] = cat.split(':')[1]
                else:
                    labels[side][cls] = cat
    return labels


def get_num_iterations_for_round(rnd):
    """Get configured number of iterations
    The rnd: Player or Subsession
    """
    idx = rnd.round_number
    num = rnd.session.params['num_iterations'][idx]
    return num


class Player(BasePlayer):
    iteration = models.IntegerField(initial=0)  # Contador para iteraciones del jugador
    num_trials = models.IntegerField(initial=0)  # Número total de intentos del jugador
    num_correct = models.IntegerField(initial=0)  # Número de respuestas correctas
    edad = models.IntegerField(label="Edad", min=18, max=120, )
    num_failed = models.IntegerField(initial=0)  # Número de respuestas incorrectas
    sexo = models.StringField(
        label="¿Cuál es tu sexo?",
        choices=[
            ('M', 'Masculino'),
            ('F', 'Femenino'),
            ('NB', 'No binario'),
            ('ND', 'Prefiero no decirlo')
        ]
    )

    random_number = models.IntegerField(label="Número aleatorio entre 1 y 20", min=1, max=20)
    ha_participado = models.StringField(
        label="¿Has participado en experimentos previamente?",
        choices=['Sí', 'No'],
        blank = True,  # <--- permitimos valor nulo al inicio

    )

    num_experimentos = models.IntegerField(
        label="¿En cuántos?",
        min=0,
        blank=True
    )

    dscore1 = models.FloatField()  # D-score del primer iat
    dscore2 = models.FloatField()  # D-score del segundo iat

    # ─── Cuestionario de comprensión 1────────────────────────────────────
    comp_q1 = models.StringField(
        label=(
            '1. ¿Supón que haces una prueba de asociación implícita que involucra a grupos A y B, en donde el grupo B es el grupo “base”. ¿Qué puntaje indicaría que tu sesgo implícito es igual al promedio de cientos de miles de participantes? ¿Qué puntaje indicaría que tu sesgo implícito favorece al grupo A más que el promedio de cientos de miles de participantes?'
        ),
        choices=[
            ('a',
             'a) Un puntaje positivo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje de cero indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes.'),
            ('b',
             'b) Un puntaje positivo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje negativo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes.'),
            ('c',
             'c) Un puntaje de cero indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje positivo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes.'),
            ('d',
             'd) Un puntaje de cero indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje negativo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '),
            ('e',
             'e) Un puntaje negativo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje de cero indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes.'
             ),
            ('f',
             'f) Un puntaje negativo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje positivo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '
             ),
        ],
        blank=False,
    )

    comp_q2 = models.StringField(
        label=(
            '2. ¿Cuáles son las dos características que hace que la Prueba de Asociación Implícita sea una manera robusta de medir sesgos que tal vez ni siquiera sabías que tenías?'
        ),
        choices=[
            ('a', 'a) Primero, hay una base de datos con cientos de miles de participantes que ya tomaron la prueba. Segundo, fue desarrollado por académicos.'),
            ('b', 'b) Primero, está ligado a comportamientos relevantes en el mundo real. Segundo, es difícil de manipular ya que mide tu respuesta automática, sin que hayas tenido tiempo de pensar. '),
            ('c', 'c) Primero, no existen otras pruebas para medir sesgos. Segundo, es fácil de implementar.'),
        ],
        blank=False,
    )

    stage_order = models.LongStringField(
        blank=True,
        label="Arrastra las etapas para ponerlas en el orden correcto:"
    )

    # comp_q3 = models.StringField(
    #     label=(
    #         '3. Calcula la cantidad de dinero con la que termina el siguiente participante: <br>'
    #         '  • Paga el costo para decidir dar o quitar 20 pesos a cada miembro del grupo.<br>'
    #         '  • Expresa su opinión privada ante el grupo y gana 10 pesos.<br>'
    #         '  • Los otros miembros de su grupo deciden quitarle 20 pesos.<br>'
    #         '  • Adivina correctamente el porcentaje de personas que expresaron una opinión diferente a su opinión privada en esas "conversaciónes", y recibe 10 pesos extra.<br>'
    #         '  • Advinó incorrectamente si la opinión que le expresaron los demás miembros es igual a su opinión privada.<br>'
    #     ),
    #     choices=[
    #         ('a', 'a) Termina con 25 pesos'),
    #         ('b', 'b) Termina con -25 pesos. Es decir, acaba sin dinero.'),
    #         ('c', 'c) Termina con 30 pesos'),
    #         ('d', 'd) Termina con 45 pesos')
    #     ],
    # )

    comp_q4 = models.StringField(
        label=(
            '4. ¿En la Etapa 5 (qué información revelar en la Etapa 6), ¿cómo tomas la decisión de qué se te revela en la Etapa 6?'
        ),
        choices=[
            ('a', '4. Caclula la cantidad de dinero con la que termina el siguiente participante: <br>'
            '  • Paga el costo para decidir dar o quitar 20 pesos a cada miembro del grupo.<br>'
            '  • Expresa la opinión alterna a su opinión privada.<br>'
            '  • Los otros miembros no pagan el costo para decidir dar o quitar 20 pesos.<br>'
            '  • Adivina correctamente el porcentaje de personas que expresaron una opinión diferente a su opinión privada en esas "conversaciónes", y recibe 10 pesos extra.<br>'
            '  • Advina correctamente si la opinión que le expresaron los demás miembros es igual a su opinión privada, y recibe 10 pesos adicionales.<br>'),
            ('b', 'b) Tomas una decisión para cada grupo a los cuales puedes afectar monetariamente en la Etapa 6: decides directamente si se te informa o no sobre la identidad de cada grupo cuando estés en la Etapa 6.'),
            ('c', 'c) Nos vas a decir si quieres que te revelemos la identidad de los grupos correspondientes a una decisión dependiendo de si tu puntaje en la prueba de asociación implícita cayó debajo, dentro o arriba del rango que consideras aceptable. '),
            ],
        blank=False,
    )

    comp_q5 = models.StringField(
        label=(
            '5. Supón que nos indicas que quieres que en la Etapa 6 te revelemos la identidad de los grupos A y B, y que no te revelemos la identidad de los grupos C y D. ¿Qué haríamos en la práctica?'
        ),
        choices=[
            ('a', 'a) Te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D.'),
            ('b', 'b) Te revelamos la identidad de los grupos A y B con 80% de probabilidad, y con 20% de probabilidad no te revelamos la identidad de los grupos A y B. No te revelamos la dentidad de los grupos C y D.'),
            ('c', 'c) Te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D con 80% de probabilidad, y con 20% de probabilidad sí te revelamos la identidad de los grupos C y D. '),
            ('d', 'd) Te revelamos la identidad de los grupos A y B con 80% de probabilidad, y con 20% de probabilidad no te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D con 80% de probabilidad, y con 20% de probabilidad sí te revelamos la identidad de los grupos C y D.'),
        ],
        blank=False,
    )

    comp_q6 = models.StringField(
        label=(
            '6. Escoge la opción correcta sobre tus decisiones en la Etapa 6.'
        ),
        choices=[
            ('a', 'a) Ninguna decisión involucra a los grupos de personas sobre las que te preguntamos en las pruebas de la Etapa 2, y sólo vamos a incluir decisiones que no afecten a las personas sobre las que te preguntamos en la Etapa 2. '),
            ('b',
             'b) No todas las decisiones involucran a los grupos de personas sobre las que te preguntamos en las pruebas de la Etapa 2, y es posible que incluyamos decisiones que no afecten a algunas de las personas sobre las que te preguntamos en la Etapa 2. '),
            ('c',
             'c) Todas las decisiones involucran a los grupos de personas sobre las que te preguntamos en las pruebas de la Etapa 2, y ninguna decisión van a incluir a grupos de personas sobre las que no te preguntamos en la Etapa 2. '),
        ],

        blank=False,
    )

    # ─── Cuestionario de comprensión 2────────────────────────────────────
    comp_q1_2 = models.StringField(
        label=(
            '1. ¿dssadas de las siguientes opciones describe correctamente las acciones disponibles para un participante una vez que se formó su grupo en el experimento?'
        ),
        choices=[
            ('a',
             'a) Escoger qué opinión expresarle a los demás en el grupo. Decidir si dar o quitar dinero a cada uno de los miembros. Adivinar si la opinión que los demás miembros te expresaron es la misma que expresaron en privado. Adivina el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.'),
            ('b',
             'b) Escoger qué opinión expresarle a los demás en el grupo. Adivinar si la opinión que los demás mimebros te expresaron es la misma que expresaron en privado. Adivina el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.'),
            ('c',
             'c) Escoger qué opinión expresarle a los demás en el grupo. Entre quienes pagaron cinco pesos por hacerlo decidir si dar o quitar dinero a cada uno de los demás miembros del grupo. Adivinar si la opinión que los demás miembros te expresaron es la misma que expresaron en privado. Adivina el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.'),
            ('d',
             'd) Escoger qué opinión expresarle a los demás en el grupo. Entre quienes pagaron cinco pesos por hacerlo decidir si dar o quitar dinero a cada uno de los demás miembros del grupo. Adivina el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.'),
        ],
        blank=False,
    )

    comp_q2_2 = models.StringField(
        label=(
            '2. ¿Qué sucede si un participante decide pagar el costo (5 pesos) para darle o quitarle 20 pesos a los demás miembros de su grupo, y el participante decide quitarle 20 pesos a uno de ellos?'
        ),
        choices=[
            ('a', 'a) El participante gana 20 pesos'),
            ('b', 'b) El participante recupera los 5 pesos pagados y el otro miembro gana 20 pesos adicionales'),
            ('c', 'c) Sólo el que paga pierde dinero; el otro miembro no gana ni pierde nada'),
            ('d', 'd) El participante pierde 5 pesos y el otro miembro pierde 20 pesos'),
        ],
        blank=False,
    )

    comp_q3_2 = models.StringField(
        label=(
            '3. Calcula la cantidad de dinero con la que termina el siguiente participante: <br>'
            '  • Paga el costo para decidir dar o quitar 20 pesos a cada miembro del grupo.<br>'
            '  • Expresa su opinión privada ante el grupo y gana 10 pesos.<br>'
            '  • Los otros miembros de su grupo deciden quitarle 20 pesos.<br>'
            '  • Adivina correctamente el porcentaje de personas que expresaron una opinión diferente a su opinión privada en esas "conversaciónes", y recibe 10 pesos extra.<br>'
            '  • Advinó incorrectamente si la opinión que le expresaron los demás miembros es igual a su opinión privada.<br>'
        ),
        choices=[
            ('a', 'a) Termina con 25 pesos'),
            ('b', 'b) Termina con -25 pesos. Es decir, acaba sin dinero.'),
            ('c', 'c) Termina con 30 pesos'),
            ('d', 'd) Termina con 45 pesos')
        ],
    )

    comp_q4_2 = models.StringField(
        label=(
            '4. Caclula la cantidad de dinero con la que termina el siguiente participante: <br>'
            '  • Paga el costo para decidir dar o quitar 20 pesos a cada miembro del grupo.<br>'
            '  • Expresa la opinión alterna a su opinión privada.<br>'
            '  • Los otros miembros no pagan el costo para decidir dar o quitar 20 pesos.<br>'
            '  • Adivina correctamente el porcentaje de personas que expresaron una opinión diferente a su opinión privada en esas "conversaciónes", y recibe 10 pesos extra.<br>'
            '  • Advina correctamente si la opinión que le expresaron los demás miembros es igual a su opinión privada, y recibe 10 pesos adicionales.<br>'
        ),
        choices=[
            ('a', 'a) Termina con 40 pesos'),
            ('b', 'b) Termina con 15 pesos'),
            ('c', 'c) Termina con 65 pesos'),
            ('d', 'd) Termina con 50 pesos'),
        ],
        blank=False,
    )

    comp_q5_2 = models.StringField(
        label=(
            '¿Cómo se crean los grupos de tres personas en el experimento?'
        ),
        choices=[
            ('a', 'a) Según sus características personales (por ejemplo, edad o género)'),
            ('b', 'b) Los participantes eligen libremente a los mimebros de su grupo'),
            ('c', 'c) De forma totalmente aleatoria'),
            ('d',
             'd) Basándose en las opiniones privadas de los participantes sobre cada uno de los temas de la Parte 3 del experimento'),
        ],
        blank=False,
    )

    comp_q6_2 = models.StringField(
        label=(
            '6. ¿Qué es lo que cada participantes debe adivinar sobre los miembros de su grupo en este experimento?'
        ),
        choices=[
            ('a', 'a) Si la opinión que los demás miembros le expresaron es la misma que expresaron en privado'),
            ('b',
             'b) La decisión que tomará cada uno de los mimebros sobre dar o quitar 20 pesos a los demás y si la opinión que los demás miembros le expresaron es la misma que expresaron en privado'),
            ('c',
             'c) Si la opinión que los demás miembros te expresaron es la misma que expresaron en privado y el porcentaje de gente que le expresaron a su grupo una opinión que no es su opinón privada.'),
            ('d', 'd) Si la opinión que los demás miembros le expresaron es diferente a su opinión privada'),
        ],
        blank=False,
    )

    comp_q7_2 = models.StringField(
        label=(
            '7. (Verdadero o Falso) Los participantes no sabrán quiénes son los demás miembros de cada grupo en los que estén.'
        ),
        choices=[
            ('a',
             'a) Verdadero: los participantes no sabrán quiénes son los demás miembros de cada grupo en los que estén.'),
            ('b',
             'b) Falso: los participantes sí sabrán quiénes son los demás miembros de cada grupo en los que estén.'),
        ],
        blank=False,
    )


    iat1_self_assessment = models.StringField(
        label="¿Cómo crees que te fue en el IAT de Personas obesas y Personas delgadas?",
        choices=[
        "Neutral",
        "Leve: Personas delgadas+bueno, Personas obesas+malo",
        "Moderada: Personas delgadas+bueno, Personas obesas+malo",
        "Fuerte: Personas delgadas+bueno, Personas obesas+malo",
        "Leve: Personas obesas+bueno, Personas delgadas+malo",
        "Moderada: Personas obesas+bueno, Personas delgadas+malo",
        "Fuerte: Personas obesas+bueno, Personas delgadas+malo",
    ],
        widget=widgets.RadioSelect
    )

    iat2_self_assessment = models.StringField(
        label="¿Cómo crees que te fue en el IAT de Personas homosexuales y Personas heterosexuales?",
        choices=[
            "Neutral",
            "Leve: Personas heterosexuales+bueno, Personas homosexuales+malo",
            "Moderada: Personas heterosexuales+bueno, Personas homosexuales+malo",
            "Fuerte: Personas heterosexuales+bueno, Personas homosexuales+malo",
            "Leve: Personas homosexuales+bueno, Personas heterosexuales+malo",
            "Moderada: Personas homosexuales+bueno, Personas heterosexuales+malo",
            "Fuerte: Personas homosexuales+bueno, Personas heterosexuales+malo",
        ],
        widget=widgets.RadioSelect
    )

    # Variables para el rango moralmente aceptable del iat 1. nota: hay que cambiar esto para que vayan de -2 a 2.
    iat2_lower_limit = models.FloatField(
        label="¿Cuál es el límite inferior del rango aceptable para el IAT Personas homosexuales y Personas heterosexuales?",
        help_text="Debe estar entre -2 y 2.",
        min=-2,
        max=2
    )

    iat2_upper_limit = models.FloatField(
        label="¿Cuál es el límite superior del rango aceptable para el IAT Personas homosexuales y Personas heterosexuales?",
        help_text="Debe estar entre -2 y 2.",
        min=-2,
        max=2
    )

    # Variables para el rango moralmente aceptable del iat 2
    iat1_lower_limit = models.FloatField(
        label="¿Cuál es el límite inferior del rango aceptable para el IAT Personas obesas y Personas delgadas?",
        help_text="Debe estar entre -2 y 2.",
        min=-2,
        max=2
    )

    iat1_upper_limit = models.FloatField(
        label="¿Cuál es el límite superior del rango aceptable para el IAT Personas obesas y Personas delgadas?",
        help_text="Debe estar entre -2 y 2.",
        min=-2,
        max=2
    )

    iat2_probability_right = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "homosexuales y el otro grupo es una o más personas heterosexuales. Además supón "
            "que tu puntaje en la prueba de asociación implícita con gente homosexual y heterosexual "
            "cae por arriba del rango que consideras aceptable. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los homosexuales y el grupo B son los heterosexuales, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    iat1_probability_left = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "obesas y el otro grupo es una o más personas delgadas. Además supón "
            "que tu puntaje en la prueba de asociación implícita con gente gorda y delgada "
            "cae por debajo del rango que consideras aceptable. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los gordos y el grupo B son los delgados, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    iat2_probability_left = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "homosexuales y el otro grupo es una o más personas heterosexuales. Además supón "
            "que tu puntaje en la prueba de asociación implícita con gente homosexual y heterosexual "
            "cae por debajo del rango que consideras aceptable. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los homosexuales y el grupo B son los heterosexuales, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    iat1_probability_right = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "obesas y el otro grupo es una o más personas delgadas. Además supón "
            "que tu puntaje en la prueba de asociación implícita con gente gorda y delgada "
            "cae por arriba del rango que consideras aceptable. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los gordos y el grupo B son los delgados, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    iat2_probability = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "homosexuales y el otro grupo es una o más personas heterosexuales. Además supón "
            "que tu puntaje en la prueba de asociación implícita con gente homosexual y heterosexual "
            "cae en el rango que consideras aceptable. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los homosexuales y el grupo B son los heterosexuales, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    iat1_probability = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "obesas y el otro grupo es una o más personas delgadas. Además supón "
            "que tu puntaje en la prueba de asociación implícita con gente gorda y delgada "
            "cae en el rango que consideras aceptable. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los gordos y el grupo B son los delgados, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    iat2_probability_right2 = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "gordas y el otro grupo es una o más personas delgadas. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los gordos y el grupo B son los delgados, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    iat1_probability_left2 = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "gordas y el otro grupo es una o más personas delgadas. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los gordos y el grupo B son los delgados, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    iat2_probability_left2 = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "gordas y el otro grupo es una o más personas delgadas. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los gordos y el grupo B son los delgados, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    iat1_probability_right2 = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "gordas y el otro grupo es una o más personas delgadas. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los gordos y el grupo B son los delgados, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    iat2_probability2 = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "gordas y el otro grupo es una o más personas delgadas. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los gordos y el grupo B son los delgados, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    iat1_probability2 = models.BooleanField(
        label=(
            "Supón que en la Etapa 6 tomas una decisión con consecuencias monetarias "
            "para el Grupo A y el Grupo B, donde uno de los grupos es una o más personas "
            "gordas y el otro grupo es una o más personas delgadas. ¿Qué prefieres?"
        ),
        widget=widgets.RadioSelect,
        choices=[
            (True,
             "Saber quiénes son del grupo A y quiénes son del grupo B (esto es, sabes si el grupo A son los gordos y el grupo B son los delgados, o al revés)."),
            (False, "No saber quiénes son del grupo A y quiénes son del grupo B."),
        ],
        blank=True,
    )

    # Variables para capturar la asociación calculada (se asignan en DictatorIntroduction)
    iat1_association = models.StringField(blank=True)
    iat2_association = models.StringField(blank=True)

    # Nuevas variables para capturar si el jugador adivinó su resultado
    iat1_guess_correct = models.BooleanField(blank=True)
    iat2_guess_correct = models.BooleanField(blank=True)

    # Nuevas variables para capturar si el iat del jugador está en su rango moralmente aceptable
    iat1_moral_range = models.BooleanField(blank=True)
    iat2_moral_range = models.BooleanField(blank=True)

    # Nuevas variables para capturar si el iat del jugador está en su rango moralmente aceptable
    iat1_moral_range_left = models.BooleanField(blank=True)
    iat2_moral_range_left = models.BooleanField(blank=True)

    # Nuevas variables para capturar si el iat del jugador está en su rango moralmente aceptable
    iat1_moral_range_right = models.BooleanField(blank=True)
    iat2_moral_range_right = models.BooleanField(blank=True)



    # campos para el juego del dictador.
    dictator_offer = models.CurrencyField(
        min=0,
        max=Constants.endowment,
        label="¿Cuánto te gustaría ofrecer?"
    )

    # ——— Cuestionario grupo 1 —————

    compr1_q1 = models.StringField(
        choices=[
            ['A', 'Un puntaje bueno indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje de cero indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '],
            ['B', 'Un puntaje bueno indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje malo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '],
            ['C', 'Un puntaje de cero indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje bueno indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '],
            ['D', 'Un puntaje de cero indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje malo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '],
            ['E', 'Un puntaje malo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje de cero indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '],
            ['F', 'Un puntaje malo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje bueno indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes.'],
        ],
        #a
        blank=True,
        label="Supón que haces una Prueba de asociación implícita que involucra a grupos A y B, en donde el grupo B es el grupo “base”. ¿Qué puntaje indicaría que tu sesgo implícito es igual al promedio de cientos de miles de participantes? ¿Qué puntaje indicaría que tu sesgo implícito favorece al grupo A más que el promedio de cientos de miles de participantes?"
    )

    # Pregunta 2 para grupo 1 (ahora radio, no múltiple)
    compr1_q2 = models.StringField(
        choices=[
            ['A',
             'Primero, hay una base de datos con cientos de miles de participantes que ya tomaron la prueba. Segundo, fue desarrollado por académicos.'],
            ['B',
             'Primero, está ligado a comportamientos relevantes en el mundo real. Segundo, es difícil de manipular ya que mide tu respuesta automática, sin que hayas tenido tiempo de pensar.'],
            ['C', 'Primero, no existen otras pruebas para medir sesgos. Segundo, es fácil de implementar.'],
        ],
        blank=True,
        label="¿Cuáles son las dos características que hacen que la iat sea una manera robusta de medir sesgos que tal vez ni siquiera sabías que tenías?"
    )

    compr1_order = models.LongStringField(
        blank=True,
        label="Arrastra las etapas para ponerlas en el orden correcto:"
    )

    compr1_q4 = models.StringField(
        choices=[
            ['A', '4. Caclula la cantidad de dinero con la que termina el siguiente participante: <br>'
            '  • Paga el costo para decidir dar o quitar 20 pesos a cada miembro del grupo.<br>'
            '  • Expresa la opinión alterna a su opinión privada.<br>'
            '  • Los otros miembros no pagan el costo para decidir dar o quitar 20 pesos.<br>'
            '  • Adivina correctamente el porcentaje de personas que expresaron una opinión diferente a su opinión privada en esas "conversaciónes", y recibe 10 pesos extra.<br>'
            '  • Advina correctamente si la opinión que le expresaron los demás miembros es igual a su opinión privada, y recibe 10 pesos adicionales.<br>'],
            ['B', 'Tomas una decisión para cada grupo a los cuales puedes afectar monetariamente en la Etapa 6: decides directamente si se te informa o no sobre la identidad de cada grupo cuando estés en la Etapa 6.'],
            ['C', 'Nos vas a decir si quieres que te revelemos la identidad de los grupos correspondientes a una decisión dependiendo de si tu puntaje en la iat cayó debajo, dentro o arriba del rango que consideras aceptable.'],
        ],
        blank=True,
        label="En la Etapa 5 (qué información revelar en la Etapa 6), ¿cómo tomas la decisión de qué se te revela en la Etapa 6?"
    )

    compr1_q5 = models.StringField(
        choices=[
            ['A', 'Te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D.'],
            ['B', 'Te revelamos la identidad de los grupos A y B con 80% de probabilidad, y con 20% de probabilidad no te revelamos la identidad de los grupos A y B. No te revelamos la dentidad de los grupos C y D.'],
            ['C', 'Te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D con 80% de probabilidad, y con 20% de probabilidad sí te revelamos la identidad de los grupos C y D.'],
            ['D', 'Te revelamos la identidad de los grupos A y B con 80% de probabilidad, y con 20% de probabilidad no te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D con 80% de probabilidad, y con 20% de probabilidad sí te revelamos la identidad de los grupos C y D.'],
        ],
        blank=True,
        label="Supón que nos indicas que quieres que en la Etapa 6 te revelemos la identidad de los grupos A y B, y que no te revelemos la identidad de los grupos C y D. ¿Qué haríamos en la práctica?"
    )

    compr1_q6 = models.StringField(
        choices=[
            ['A', 'Ninguna decisión involucra a los grupos de Personas sobre las que te preguntamos en las pruebas de la Etapa 2, y sólo vamos a incluir decisiones que no afecten a las Personas sobre las que te preguntamos en la Etapa 2. '],
            ['B', 'No todas las decisiones involucran a los grupos de Personas sobre las que te preguntamos en las pruebas de la Etapa 2, y es posible que incluyamos decisiones que no afecten a algunas de las Personas sobre las que te preguntamos en la Etapa 2. '],
            ['C', 'Todas las decisiones involucran a los grupos de Personas sobre las que te preguntamos en las pruebas de la Etapa 2, y ninguna decisión van a incluir a grupos de Personas sobre las que no te preguntamos en la Etapa 2.'],
        ],
        blank=True,
        label="Escoge la opción correcta sobre tus decisiones en la Etapa 6."
    )

    # ——— Cuestionario grupo 2 —————

    compr2_q1 = models.StringField(
        choices=[
            ['A', 'Un puntaje bueno indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje de cero indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '],
            ['B', 'Un puntaje bueno indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje malo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes.'],
            ['C', 'Un puntaje de cero indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje bueno indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '],
            ['D', 'Un puntaje de cero indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje malo indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '],
            ['E', 'Un puntaje malo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje de cero indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes. '],
            ['F', 'Un puntaje malo indica que mi sesgo implícito es igual al promedio de cientos de miles de participantes. Un puntaje bueno indica que mi sesgo implícito favorece al grupo A más que cientos de miles de participantes.'],
        ],
        blank=True,
        label="Supón que haces una Prueba de asociación implícita que involucra a grupos A y B, en donde el grupo B es el grupo “base”. ¿Qué puntaje indicaría que tu sesgo implícito es igual al promedio de cientos de miles de participantes? ¿Qué puntaje indicaría que tu sesgo implícito favorece al grupo A más que el promedio de cientos de miles de participantes?"
    )

    # Pregunta 2 para grupo 2 (igual)
    compr2_q2 = models.StringField(
        choices=[
            ['A',
             'Primero, hay una base de datos con cientos de miles de participantes que ya tomaron la prueba. Segundo, fue desarrollado por académicos.'],
            ['B',
             'Primero, está ligado a comportamientos relevantes en el mundo real. Segundo, es difícil de manipular ya que mide tu respuesta automática, sin que hayas tenido tiempo de pensar.'],
            ['C', 'Primero, no existen otras pruebas para medir sesgos. Segundo, es fácil de implementar.'],
        ],
        blank=True,
        widget=widgets.RadioSelect,
        label="¿Cuáles son las dos características que hacen que la iat sea una manera robusta de medir sesgos que tal vez ni siquiera sabías que tenías?"
    )

    compr2_order = models.LongStringField(
        blank=True,
        label="Arrastra las etapas para ponerlas en el orden correcto:"
    )

    compr2_q4 = models.StringField(
        choices=[
            ['A', 'Tomas una sola decisión sobre todos los grupos a los cuales puedes afectar monetariamente en la Etapa 6: decides directamente si se te informa o no sobre la identidad de todos los grupos cuando estés en la Etapa 6.'],
            ['B', 'Tomas una decisión para cada grupo a los cuales puedes afectar monetariamente en la Etapa 6: decides directamente si se te informa o no sobre la identidad de cada grupo cuando estés en la Etapa 6.'],
            ['C', 'Nos vas a decir si quieres que te revelemos la identidad de los grupos correspondientes a una decisión dependiendo de si tu puntaje en la iat cayó debajo, dentro o arriba del rango que consideras aceptable.'],
        ],
        blank=True,
        widget=widgets.RadioSelect,
        label="En la Etapa 5 (qué información revelar en la Etapa 6), ¿cómo tomas la decisión de qué se te revela en la Etapa 6?"
    )

    compr2_q5 = models.StringField(
        choices=[
            ['A', 'Te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D.'],
            ['B', 'Te revelamos la identidad de los grupos A y B con 80% de probabilidad, y con 20% de probabilidad no te revelamos la identidad de los grupos A y B. No te revelamos la dentidad de los grupos C y D.'],
            ['C', 'Te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D con 80% de probabilidad, y con 20% de probabilidad sí te revelamos la identidad de los grupos C y D.'],
            ['D', 'Te revelamos la identidad de los grupos A y B con 80% de probabilidad, y con 20% de probabilidad no te revelamos la identidad de los grupos A y B. No te revelamos la identidad de los grupos C y D con 80% de probabilidad, y con 20% de probabilidad sí te revelamos la identidad de los grupos C y D.'],
        ],
        blank=True,
        widget=widgets.RadioSelect,
        label="Supón que nos indicas que quieres que en la Etapa 6 te revelemos la identidad de los grupos A y B, y que no te revelemos la identidad de los grupos C y D. ¿Qué haríamos en la práctica?"
    )

    compr2_q6 = models.StringField(
        choices=[
            ['A', 'Ninguna decisión involucra a los grupos de Personas sobre las que te preguntamos en las pruebas de la Etapa 2, y sólo vamos a incluir decisiones que no afecten a las Personas sobre las que te preguntamos en la Etapa 2.'],
            ['B', 'No todas las decisiones involucran a los grupos de Personas sobre las que te preguntamos en las pruebas de la Etapa 2, y es posible que incluyamos decisiones que no afecten a algunas de las Personas sobre las que te