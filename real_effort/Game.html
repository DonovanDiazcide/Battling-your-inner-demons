{{ block title }}
Real-effort task
{{ endblock }}

{{ block content }}
<div class="d-flex flex-column align-items-center">
    <h3>
        Iteration <span id="iter-txt"></span>
    </h3>
    <p>Solved: <span id="solved-txt"></span>. Failed: <span id="failed-txt"></span>.</p>
    <img class="captcha m-1" id="captcha-img">

    <div class="input-group m-1">
        <input type="text" id="answer-inp" class="form-control">
        <button type="button" id="submit-btn" class="btn btn-outline-secondary">Submit</button>
    </div>

    <p class="warn" id="warning-txt"></p>

    {{ if DEBUG }}
    <button type="button" id="cheat-btn" class="btn btn-dark">Cheat</button>
    {{ endif }}
</div>
<br>
{{ include Constants.instructions_template }}

{{ endblock }}

{{ block scripts }}
<script>
    let isFrozen = false;
    let image = document.getElementById('captcha-img');
    let input = document.getElementById('answer-inp');
    let warn = document.getElementById('warning-txt');
    let submit_btn = document.getElementById('submit-btn');
    let fields = {
        iter: document.getElementById('iter-txt'),
        solved: document.getElementById('solved-txt'),
        failed: document.getElementById('failed-txt'),
    }

    function setFrozen(val) {
        input.disabled = val;
        submit_btn.disabled = val;
        isFrozen = val;
        input.focus();
    }

    function clearInputValidity() {
        input.classList.remove("is-valid", "is-invalid");
    }

    input.oninput = function (ev) {
        clearInputValidity();
    }

    input.onkeydown = function (ev) {
        if (ev.key === 'Enter' && !submit_btn.disabled) {
            submit();
        }
    }

    submit_btn.onclick = function (ev) {
        submit();
    }

    function submit() {
        if (isFrozen || input.value === '') return;
        send_answer(input.value);
    }

    function liveRecv(data) {
        let {image, ...dataExceptImage} = data;
        console.log(dataExceptImage);
        if ('freeze' in data) {
            tempFreeze(data.freeze);
        }
        if ('is_correct' in data) {
            feedback(data.is_correct);
        }
        if ('image' in data ) {
            new_puzzle(data.image);
        }
        if ('gameover' in data) {
            gameover();
        }
        if ('stats' in data) {
            stats(data.stats);
        }
        if ('solution' in data) {
            cheat(data.solution);
        }
    }

    function clear() {
        image.src = "";
        input.value = "";
    }

    function new_puzzle(img) {
        setFrozen(false);
        clear();
        image.src = img;
    }

    function send_answer(answer) {
        clearInputValidity();
        setFrozen(true);
        liveSend({answer: answer});
    }

    function feedback(is_correct) {
        input.classList.add(is_correct ? "is-valid" : "is-invalid");
    }

    function waitMsg(seconds) {
        warn.textContent = `Wait ${Math.round(seconds)} seconds before trying again`;
    }

    function tempFreeze(countdown) {
        setFrozen(true);
        waitMsg(countdown);
        let timer = window.setInterval(function() {
            countdown -= 1;
            if (countdown > 0) {
                waitMsg(countdown);
            } else {
                setFrozen(false);
                warn.textContent = "";
                clearInputValidity();
                clearInterval(timer);
            }
        }, 1000);
    }

    function stats(stats) {
        fields.iter.textContent = stats.iteration;
        fields.solved.textContent = stats.num_correct;
        fields.failed.textContent = stats.num_incorrect;
    }

    function gameover() {
        document.getElementById("form").submit();
    }

    document.addEventListener("DOMContentLoaded", (event) => {
        liveSend({});
    });
</script>

{{ if DEBUG }}
<script>
    let cheat_btn = document.getElementById('cheat-btn');
    cheat_btn.onclick = function() {
        liveSend({cheat: true});
    }

    function cheat(solution) {
        input.value = solution;
    }
</script>
{{ endif }}

{{ endblock }}